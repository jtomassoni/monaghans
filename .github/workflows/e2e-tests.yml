name: E2E Tests

# Parallelization Strategy:
# - Default: 4 workers running tests in parallel within a single job
# - Configure via PLAYWRIGHT_WORKERS environment variable (default: 4)
# - For even more speed, you can enable sharding by uncommenting the matrix strategy below
#   and splitting tests across multiple CI jobs

# E2E tests disabled - uncomment to re-enable
# on:
#   push:
#     branches: [main, develop]
#   pull_request:
#     branches: [main, develop]
#   workflow_dispatch:
on:
  workflow_dispatch:  # Only allow manual runs if needed

jobs:
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: monaghans_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üìã Print environment info
        run: |
          echo "::group::üîç Environment Information"
          echo "Node version: $(node --version)"
          echo "npm version: $(npm --version)"
          echo "OS: $(uname -a)"
          echo "Working directory: $(pwd)"
          echo "Git branch: ${{ github.ref }}"
          echo "Git commit: ${{ github.sha }}"
          echo "::endgroup::"

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
        env:
          NODE_OPTIONS: '--max-old-space-size=4096'

      - name: üì• Install dependencies
        run: |
          echo "::group::üì¶ Installing dependencies"
          npm ci
          echo "::endgroup::"
          echo "‚úÖ Dependencies installed successfully"

      - name: üîß Generate Prisma Client
        run: |
          echo "::group::üîß Generating Prisma Client"
          npm run db:generate
          echo "::endgroup::"
          echo "‚úÖ Prisma Client generated"

      - name: üêò Install PostgreSQL client
        run: |
          echo "::group::üêò Installing PostgreSQL client"
          sudo apt-get update
          sudo apt-get install -y postgresql-client
          echo "::endgroup::"
          echo "‚úÖ PostgreSQL client installed"

      - name: üóÑÔ∏è Setup test database
        run: |
          echo "::group::üóÑÔ∏è Setting up test database"
          echo "Database URL: ${DATABASE_URL}"
          echo "Superadmin Users: ${SUPERADMIN_USERS}"
          echo "Owner Users: ${OWNER_USERS}"
          echo ""
          echo "Waiting for PostgreSQL to be ready..."
          until pg_isready -h localhost -p 5432 -U postgres; do
            echo "Waiting for PostgreSQL..."
            sleep 1
          done
          echo "‚úÖ PostgreSQL is ready"
          echo ""
          echo "Running test database setup script..."
          npm run test:setup
          echo ""
          echo "‚úÖ Test database seeded successfully"
          echo "::endgroup::"
          echo "‚úÖ Test database setup complete"
        env:
          DATABASE_URL: "postgresql://postgres:postgres@localhost:5432/monaghans_test?schema=public"
          SUPERADMIN_USERS: ${{ secrets.SUPERADMIN_USERS || 'jt:test' }}
          OWNER_USERS: ${{ secrets.OWNER_USERS || 'owner:test' }}
          NEXTAUTH_SECRET: "test-secret-for-ci-only-do-not-use-in-production"
          NEXTAUTH_URL: "http://localhost:3000"

      - name: üé≠ Install Playwright browsers
        run: |
          echo "::group::üé≠ Installing Playwright browsers"
          npx playwright install --with-deps chromium
          echo "::endgroup::"
          echo "‚úÖ Playwright browsers installed"

      - name: üìù List test files
        run: |
          echo "::group::üìù Test Files to Execute"
          find ./e2e -name "*.spec.ts" -o -name "*.setup.ts" | sort
          echo "::endgroup::"

      - name: üß™ Run E2E tests
        run: |
          echo "::group::üß™ Running E2E tests"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "üöÄ Starting Playwright E2E Test Execution"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo ""
          echo "üìã Configuration:"
          echo "  - Base URL: ${PLAYWRIGHT_TEST_BASE_URL:-http://localhost:3000}"
          echo "  - Test directory: ./e2e"
          echo "  - Database: ${DATABASE_URL}"
          echo "  - CI Mode: ${CI}"
          echo "  - Workers: ${PLAYWRIGHT_WORKERS:-4} (parallel execution)"
          echo "  - Retries: 2 (on failure)"
          if [ -n "${SHARD}" ]; then
            echo "  - Shard: ${SHARD} (shard ${SHARD_INDEX:-1} of ${SHARD_TOTAL:-1})"
          fi
          echo ""
          echo "üìä Reporters:"
          echo "  - list (detailed console output)"
          echo "  - html (interactive report)"
          echo "  - github (GitHub Actions annotations)"
          echo ""
          echo "üé¨ Starting tests..."
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo ""
          
          # Run tests with verbose output
          # Support sharding if SHARD environment variable is set (format: "1/3" for shard 1 of 3)
          set +e  # Don't exit on error immediately
          if [ -n "${SHARD}" ]; then
            echo "Running tests with sharding: ${SHARD}"
            npm run test:e2e -- --reporter=list,html,github --shard=${SHARD}
          else
            npm run test:e2e -- --reporter=list,html,github
          fi
          TEST_EXIT_CODE=$?
          set -e  # Re-enable exit on error
          
          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          if [ "${TEST_EXIT_CODE}" -eq 0 ]; then
            echo "‚úÖ All tests passed!"
          else
            echo "‚ùå Tests failed with exit code: ${TEST_EXIT_CODE}"
          fi
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "::endgroup::"
          
          # Exit with the test exit code
          exit ${TEST_EXIT_CODE}
        env:
          CI: true
          DATABASE_URL: "postgresql://postgres:postgres@localhost:5432/monaghans_test?schema=public"
          NEXTAUTH_URL: "http://localhost:3000"
          NEXTAUTH_SECRET: "test-secret-for-ci-only-do-not-use-in-production"
          SUPERADMIN_USERS: ${{ secrets.SUPERADMIN_USERS || 'jt:test' }}
          OWNER_USERS: ${{ secrets.OWNER_USERS || 'owner:test' }}
          PLAYWRIGHT_TEST_BASE_URL: "http://localhost:3000"
          # Parallelization: Use 4 workers by default (can be overridden)
          PLAYWRIGHT_WORKERS: ${{ vars.PLAYWRIGHT_WORKERS || '4' }}
          # Disable features that might interfere with tests
          ENABLE_ONLINE_ORDERING: "false"
          ENABLE_SOCIAL_POSTING: "false"

      - name: üìä Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
          if-no-files-found: ignore

      - name: üì∏ Upload test screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-screenshots
          path: test-results/**/*.png
          retention-days: 7
          if-no-files-found: ignore

      - name: üé• Upload test videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-videos
          path: test-results/**/*.webm
          retention-days: 7
          if-no-files-found: ignore

      - name: üìù Upload test traces
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-traces
          path: test-results/**/*.zip
          retention-days: 7
          if-no-files-found: ignore

      - name: üìã Print test summary
        if: always()
        run: |
          echo "::group::üìã Test Execution Summary"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "üìä Test Artifacts Summary"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo ""
          
          # Check HTML report
          if [ -f "playwright-report/index.html" ]; then
            REPORT_SIZE=$(du -h playwright-report/index.html | cut -f1)
            echo "‚úÖ HTML report generated: playwright-report/index.html (${REPORT_SIZE})"
          else
            echo "‚ö†Ô∏è  HTML report not found"
          fi
          
          # Check test results directory
          if [ -d "test-results" ]; then
            echo ""
            echo "üìÅ Test results directory contents:"
            SCREENSHOTS=$(find test-results -type f -name "*.png" 2>/dev/null | wc -l)
            VIDEOS=$(find test-results -type f -name "*.webm" 2>/dev/null | wc -l)
            TRACES=$(find test-results -type f -name "*.zip" 2>/dev/null | wc -l)
            echo "  üì∏ Screenshots: ${SCREENSHOTS}"
            echo "  üé• Videos: ${VIDEOS}"
            echo "  üìù Traces: ${TRACES}"
            
            if [ "${SCREENSHOTS}" -gt 0 ] || [ "${VIDEOS}" -gt 0 ] || [ "${TRACES}" -gt 0 ]; then
              echo ""
              echo "üìÇ Artifact locations:"
              find test-results -type f \( -name "*.png" -o -name "*.webm" -o -name "*.zip" \) 2>/dev/null | head -10
            fi
          else
            echo "‚ö†Ô∏è  Test results directory not found"
          fi
          
          # Check auth state
          if [ -f ".auth/user.json" ]; then
            echo ""
            echo "üîê Auth state file exists: .auth/user.json"
          fi
          
          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "::endgroup::"

      - name: üö® Print failure details
        if: failure()
        run: |
          echo "::group::üö® Test Failure Details"
          echo "Tests failed! Check the logs above for details."
          echo ""
          echo "Artifacts uploaded:"
          echo "- playwright-report: HTML report with detailed test results"
          echo "- test-screenshots: Screenshots from failed tests"
          echo "- test-videos: Videos of test execution"
          echo "- test-traces: Playwright traces for debugging"
          echo ""
          echo "To debug locally:"
          echo "1. Download the playwright-report artifact"
          echo "2. Open playwright-report/index.html in a browser"
          echo "3. Review test traces and screenshots"
          echo "::endgroup::"

# ============================================================================
# OPTIONAL: Advanced Sharding Configuration
# ============================================================================
# For even faster test execution, you can split tests across multiple CI jobs
# using Playwright's built-in sharding. Uncomment the job below and comment
# out the single e2e-tests job above to enable sharding.
#
# Example: With 3 shards, tests will be split across 3 parallel jobs,
# potentially reducing test time by ~3x (depending on test distribution).
#
# Note: Each shard job needs its own database setup, so this uses more CI
# resources but can significantly speed up test execution for large test suites.
#
#   e2e-tests-sharded:
#     name: E2E Tests (Shard ${{ matrix.shard }})
#     runs-on: ubuntu-latest
#     timeout-minutes: 30
#     strategy:
#       fail-fast: false
#       matrix:
#         shard: [1/3, 2/3, 3/3]  # Adjust number of shards as needed
#     services:
#       postgres:
#         image: postgres:15
#         env:
#           POSTGRES_USER: postgres
#           POSTGRES_PASSWORD: postgres
#           POSTGRES_DB: monaghans_test
#         options: >-
#           --health-cmd pg_isready
#           --health-interval 10s
#           --health-timeout 5s
#           --health-retries 5
#         ports:
#           - 5432:5432
#     steps:
#       - name: üì• Checkout code
#         uses: actions/checkout@v4
#       - name: üì¶ Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: '20'
#           cache: 'npm'
#       - name: üì• Install dependencies
#         run: npm ci
#       - name: üîß Generate Prisma Client
#         run: npm run db:generate
#       - name: üóÑÔ∏è Setup test database
#         run: npm run test:setup
#         env:
#           DATABASE_URL: "postgresql://postgres:postgres@localhost:5432/monaghans_test?schema=public"
#           SUPERADMIN_USERS: ${{ secrets.SUPERADMIN_USERS || 'jt:test' }}
#           OWNER_USERS: ${{ secrets.OWNER_USERS || 'owner:test' }}
#       - name: üé≠ Install Playwright browsers
#         run: npx playwright install --with-deps chromium
#       - name: üß™ Run E2E tests (Shard ${{ matrix.shard }})
#         run: npm run test:e2e -- --reporter=list,html,github --shard=${{ matrix.shard }}
#         env:
#           CI: true
#           DATABASE_URL: "postgresql://postgres:postgres@localhost:5432/monaghans_test?schema=public"
#           NEXTAUTH_URL: "http://localhost:3000"
#           NEXTAUTH_SECRET: "test-secret-for-ci-only-do-not-use-in-production"
#           SUPERADMIN_USERS: ${{ secrets.SUPERADMIN_USERS || 'jt:test' }}
#           OWNER_USERS: ${{ secrets.OWNER_USERS || 'owner:test' }}
#           PLAYWRIGHT_TEST_BASE_URL: "http://localhost:3000"
#           PLAYWRIGHT_WORKERS: 2  # Use fewer workers per shard
#       - name: üìä Upload test results
#         if: always()
#         uses: actions/upload-artifact@v4
#         with:
#           name: playwright-report-shard-${{ matrix.shard }}
#           path: playwright-report/
#           retention-days: 30
# ============================================================================

