// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Special {
  id          String    @id @default(cuid())
  title       String
  description String?
  priceNotes  String? // e.g., "$3 drafts", "Happy hour prices"
  type        String    @default("food") // "food" or "drink"
  appliesOn   String? // JSON array of weekdays: ["Monday", "Tuesday", ...] (optional for date-specific)
  timeWindow  String? // e.g., "11am-3pm", "Happy Hour"
  startDate   DateTime? // Optional start date
  endDate     DateTime? // Optional end date
  image       String? // Path to image in /public/uploads
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Event {
  id              String    @id @default(cuid())
  title           String
  description     String?
  startDateTime   DateTime
  endDateTime     DateTime?
  venueArea       String    @default("bar") // "bar", "stage", "other"
  recurrenceRule  String? // RRULE string (RFC 5545)
  exceptions      String? // JSON array of exception dates: ["2024-01-15", ...]
  isAllDay        Boolean   @default(false)
  tags            String? // JSON array of tags: ["live-music", "trivia", ...]
  image           String? // Path to image in /public/uploads
  isActive        Boolean   @default(true)
  // Pattern tracking for calendar duplication
  dayOfWeek       Int? // 0-6 (Sunday-Saturday) for weekly events
  weekOfMonth     Int? // 1-5 (first, second, third, fourth, last) for monthly events
  monthDay        Int? // 1-31 for monthly events on specific day
  patternMetadata String? // JSON object with additional pattern info (e.g., {"frequency": "weekly", "days": ["Monday", "Wednesday"]})
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model Announcement {
  id                 String    @id @default(cuid())
  title              String
  body               String // Rich text content (markdown or HTML)
  heroImage          String? // Path to image
  publishAt          DateTime? // When to start showing the announcement
  expiresAt          DateTime? // When to stop showing the announcement
  isPublished        Boolean   @default(false)
  crossPostFacebook  Boolean   @default(false)
  crossPostInstagram Boolean   @default(false)
  ctaText            String? // Call-to-action button text
  ctaUrl             String? // Call-to-action button URL
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
}

model Setting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String // JSON value for complex data
  description String?
  updatedAt   DateTime @updatedAt
}

model PostQueue {
  id          String    @id @default(cuid())
  channel     String // "facebook", "instagram"
  payload     String // JSON payload with caption, link, image, etc.
  status      String    @default("staged") // "staged", "sent", "failed"
  scheduledAt DateTime?
  sentAt      DateTime?
  error       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model FacebookPost {
  id        String   @id @default(cuid())
  postId    String   @unique
  pageId    String
  message   String
  link      String?
  imageUrl  String?
  permalink String?
  createdBy String?
  postedAt  DateTime @default(now())
  createdAt DateTime @default(now())

  @@index([pageId])
}

model MenuSection {
  id           String     @id @default(cuid())
  name         String // e.g., "Starters", "Burgers", "Mexican"
  description  String? // Optional section description
  displayOrder Int        @default(0) // For ordering sections
  menuType     String     @default("dinner") // "breakfast", "dinner", "both"
  isActive     Boolean    @default(true)
  items        MenuItem[]
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model User {
  id         String        @id @default(cuid())
  email      String        @unique
  name       String?
  image      String? // Profile image from Google
  role       String        @default("admin") // "admin" or "owner"
  isActive   Boolean       @default(true)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  activities ActivityLog[]
}

model ActivityLog {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  action      String // "create", "update", "delete"
  entityType  String // "menuItem", "menuSection", "event", "special", "announcement", "user", "setting"
  entityId    String
  entityName  String? // Display name of the entity (e.g., "Cheeseburger")
  changes     String? // JSON object with before/after values for updates
  description String // Human-readable description (e.g., "Changed name from 'A' to 'B'")
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

model Order {
  id                  String      @id @default(cuid())
  orderNumber         String      @unique // Human-readable order number (e.g., "ORD-2025-001")
  status              String      @default("pending") // "pending", "confirmed", "acknowledged", "preparing", "ready", "completed", "cancelled"
  customerName        String
  customerEmail       String
  customerPhone       String
  customerAddress     String? // For delivery (future feature)
  pickupTime          DateTime? // Requested pickup/delivery time
  subtotal            Float       @default(0)
  tax                 Float       @default(0)
  tip                 Float       @default(0)
  bohTip              Float       @default(0) // Back of House tip portion
  fohTip              Float       @default(0) // Front of House tip portion
  total               Float       @default(0)
  paymentStatus       String      @default("pending") // "pending", "paid", "failed", "refunded"
  paymentMethod       String? // "card", "cash", etc.
  stripePaymentId     String? // Stripe payment intent ID
  specialInstructions String? // Customer notes
  items               OrderItem[]
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  completedAt         DateTime?
  // Timing fields for performance tracking
  confirmedAt         DateTime? // When order was confirmed (FOH)
  acknowledgedAt      DateTime? // When order was acknowledged by BOH
  preparingAt         DateTime? // When order started being prepared
  readyAt             DateTime? // When order was marked ready

  @@index([status])
  @@index([createdAt])
  @@index([customerEmail])
}

model OrderItem {
  id                  String    @id @default(cuid())
  orderId             String
  order               Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItemId          String? // Reference to MenuItem (null if custom item)
  menuItem            MenuItem? @relation(fields: [menuItemId], references: [id], onDelete: SetNull)
  name                String // Item name at time of order (for historical accuracy)
  description         String? // Item description at time of order
  price               Float     @default(0) // Price at time of order
  quantity            Int       @default(1)
  modifiers           String? // JSON array of selected modifiers
  specialInstructions String? // Item-specific notes
  createdAt           DateTime  @default(now())

  @@index([orderId])
  @@index([menuItemId])
}

// Add relation to MenuItem for orders
model MenuItem {
  id           String               @id @default(cuid())
  sectionId    String
  section      MenuSection          @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  name         String
  description  String? // Optional item description
  price        String? // Price as string (e.g., "$14", "$8-12", "Market Price")
  priceNotes   String? // Additional pricing info (e.g., "Full: $14, Half: $8")
  modifiers    String? // JSON array of modifier options
  isAvailable  Boolean              @default(true)
  displayOrder Int                  @default(0) // For ordering within section
  orderItems   OrderItem[] // Relation to orders
  posSaleItems POSSaleItem[] // Relation to POS sales
  ingredients  MenuItemIngredient[] // Relation to ingredients
  prepTimeMin  Int? // Prep/cook time in minutes
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  @@index([sectionId])
}

// Ingredient master list
model Ingredient {
  id           String               @id @default(cuid())
  name         String // "Mozzarella Cheese", "Tortilla - 10 inch", "Romaine Lettuce"
  category     String               @default("Other") // "Dairy", "Grains", "Vegetables", "Proteins", "Condiments", "Other"
  unit         String // "oz", "lb", "count", "cup", "tsp", "tbsp"
  costPerUnit  Float // Cost per unit (e.g., $0.15/oz for cheese)
  supplier     String? // Optional supplier info
  parLevel     Float? // Minimum stock level to maintain
  currentStock Float? // Current inventory (optional for now)
  notes        String? // Additional notes
  isActive     Boolean              @default(true)
  menuItems    MenuItemIngredient[] // Relation to menu items
  supplierProducts SupplierProduct[] // Products from suppliers that match this ingredient
  purchaseOrderItems PurchaseOrderItem[] // Purchase order items for this ingredient
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  @@index([category])
  @@index([name])
}

// Junction table: Links menu items to ingredients with quantities
model MenuItemIngredient {
  id           String     @id @default(cuid())
  menuItemId   String
  ingredientId String
  quantity     Float // e.g., 2.5 (oz), 1 (count)
  notes        String? // Optional prep notes
  menuItem     MenuItem   @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@unique([menuItemId, ingredientId])
  @@index([menuItemId])
  @@index([ingredientId])
}

// Employee management for labor cost tracking
model Employee {
  id           String                 @id @default(cuid())
  name         String
  email        String                 @unique // Required for credential management
  phone        String?
  pin          String?                @unique // PIN for timeclock access
  role         String // "cook", "bartender", "barback"
  hourlyWage   Float // Hourly wage in dollars
  isActive     Boolean                @default(true)
  deletedAt    DateTime? // Soft delete timestamp (null = not deleted)
  hireDate     DateTime?
  notes        String?
  shifts       Shift[] // Actual worked shifts (clock in/out)
  schedules    Schedule[] // Scheduled shifts (planned)
  availability EmployeeAvailability[] // Employee availability entries
  createdAt    DateTime               @default(now())
  updatedAt    DateTime               @updatedAt

  @@index([isActive])
  @@index([role])
  @@index([deletedAt])
  @@index([pin])
}

// Scheduled shifts (planned shifts for scheduling)
model Schedule {
  id         String   @id @default(cuid())
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  date       DateTime // Date of the shift (time component ignored)
  shiftType  String // "open" (open to 4pm) or "close" (4pm to close)
  startTime  DateTime // Actual start time (accounts for kitchen 1hr early)
  endTime    DateTime // Actual end time (accounts for kitchen 1hr early + cleanup)
  notes      String? // Schedule notes
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([employeeId, date, shiftType]) // One employee can't have duplicate shift types on same day
  @@index([employeeId])
  @@index([date])
}

// Shift tracking for labor cost analysis (actual worked time)
model Shift {
  id         String    @id @default(cuid())
  employeeId String
  employee   Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  scheduleId String? // Optional link to scheduled shift
  clockIn    DateTime
  clockOut   DateTime?
  breakMin   Int       @default(0) // Break time in minutes (unpaid)
  notes      String? // Shift notes
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([employeeId])
  @@index([clockIn])
  @@index([scheduleId])
}

// Shift requirements - defines how many of each role are needed per day/shift
model ShiftRequirement {
  id         String   @id @default(cuid())
  date       DateTime // Date of the requirement (time component ignored)
  shiftType  String // "open" or "close"
  cooks      Int      @default(0) // Number of cooks needed
  bartenders Int      @default(0) // Number of bartenders needed
  barbacks   Int      @default(0) // Number of barbacks needed
  notes      String? // Optional notes about this requirement
  isFilled   Boolean  @default(false) // Whether this shift is marked as filled/complete
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([date, shiftType]) // One requirement per day/shift type
  @@index([date])
}

// Weekly schedule template - default requirements for each day of the week
model WeeklyScheduleTemplate {
  id         String   @id @default(cuid())
  name       String // Template name (e.g., "Standard Week", "Holiday Week")
  dayOfWeek  Int // 0-6 (Sunday-Saturday)
  shiftType  String // "open" or "close"
  cooks      Int      @default(0)
  bartenders Int      @default(0)
  barbacks   Int      @default(0)
  notes      String? // Optional notes
  isActive   Boolean  @default(true) // Can have multiple templates, one active
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([dayOfWeek, shiftType, name]) // Unique combination per template name
  @@index([dayOfWeek, shiftType])
}

// Employee availability - monthly availability entries
model EmployeeAvailability {
  id          String   @id @default(cuid())
  employeeId  String
  employee    Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  date        DateTime // Date of availability (time component ignored)
  shiftType   String? // "open", "close", or null for all day
  isAvailable Boolean  @default(true) // true = available, false = unavailable
  notes       String? // Optional notes (e.g., "Doctor appointment")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([employeeId, date, shiftType]) // One availability entry per employee/date/shift
  @@index([employeeId])
  @@index([date])
}

// POS Integration - stores connection information for POS systems
model POSIntegration {
  id            String    @id @default(cuid())
  provider      String // "square", "toast", "clover", "lightspeed", "touchbistro", etc.
  name          String // Display name for this integration
  isActive      Boolean   @default(true)
  credentials   String // Encrypted JSON with API keys, tokens, etc.
  config        String? // JSON with configuration (location IDs, sync settings, etc.)
  lastSyncAt    DateTime? // Last successful sync timestamp
  lastSyncError String? // Last sync error message
  syncFrequency String    @default("daily") // "hourly", "daily", "weekly", "manual"
  sales         POSSale[] // Imported sales from this POS
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([provider])
  @@index([isActive])
}

// POS Sales Data - imported sales transactions from POS systems
model POSSale {
  id               String         @id @default(cuid())
  posIntegrationId String
  posIntegration   POSIntegration @relation(fields: [posIntegrationId], references: [id], onDelete: Cascade)
  posTransactionId String // Original transaction ID from POS system
  posOrderNumber   String? // Order number from POS system
  saleDate         DateTime // Date/time of sale
  subtotal         Float          @default(0)
  tax              Float          @default(0)
  tip              Float          @default(0)
  total            Float          @default(0)
  paymentMethod    String? // "card", "cash", "gift_card", etc.
  customerCount    Int? // Number of customers/guests
  serverName       String? // Server/employee name from POS
  locationId       String? // Location ID if multi-location
  items            POSSaleItem[] // Items sold in this transaction
  rawData          String? // JSON with original POS data for reference
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  @@unique([posIntegrationId, posTransactionId]) // Prevent duplicate imports
  @@index([posIntegrationId])
  @@index([saleDate])
  @@index([posOrderNumber])
}

// POS Sale Items - individual items from POS transactions
model POSSaleItem {
  id         String    @id @default(cuid())
  posSaleId  String
  posSale    POSSale   @relation(fields: [posSaleId], references: [id], onDelete: Cascade)
  posItemId  String? // Item ID from POS system
  name       String // Item name at time of sale
  category   String? // Category from POS
  quantity   Int       @default(1)
  unitPrice  Float     @default(0)
  totalPrice Float     @default(0)
  modifiers  String? // JSON array of modifiers/add-ons
  menuItemId String? // Link to MenuItem if matched
  menuItem   MenuItem? @relation(fields: [menuItemId], references: [id], onDelete: SetNull)
  createdAt  DateTime  @default(now())

  @@index([posSaleId])
  @@index([menuItemId])
  @@index([name])
}

// Supplier Integration Models
model Supplier {
  id          String              @id @default(cuid())
  name        String              @unique // "Sysco", "US Foods", "Costco", etc.
  provider    String              @unique // "sysco", "usfoods", "costco", "custom"
  displayName String? // Display name for UI
  website     String?
  phone       String?
  email       String?
  address     String?
  notes       String?
  isActive    Boolean             @default(true)
  connections SupplierConnection[]
  products    SupplierProduct[]
  pricing     SupplierPricing[]
  orders      PurchaseOrder[]
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  @@index([provider])
  @@index([isActive])
}

// Supplier API Connection - stores credentials and connection info
model SupplierConnection {
  id            String    @id @default(cuid())
  supplierId    String
  supplier      Supplier  @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  name          String // Display name for this connection (e.g., "Main Account", "Secondary Location")
  credentials   String // Encrypted JSON with API keys, tokens, account numbers, etc.
  config        String? // JSON with configuration (location IDs, warehouse codes, etc.)
  isActive      Boolean   @default(true)
  lastSyncAt    DateTime? // Last successful catalog sync
  lastSyncError String? // Last sync error message
  syncFrequency String    @default("weekly") // "daily", "weekly", "monthly", "manual"
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([supplierId])
  @@index([isActive])
}

// Supplier Product Catalog - products available from suppliers
model SupplierProduct {
  id              String           @id @default(cuid())
  supplierId      String
  supplier        Supplier         @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  supplierSku     String // SKU from supplier
  name            String
  description     String?
  category        String? // Product category
  unit            String // "lb", "oz", "case", "each", etc.
  unitSize        String? // e.g., "12/1 lb" for case of 12 one-pound packages
  currentPrice    Float // Current price per unit
  lastPriceUpdate DateTime? // When price was last updated
  isAvailable     Boolean          @default(true)
  minOrderQty     Float? // Minimum order quantity
  leadTimeDays    Int? // Typical lead time in days
  ingredientId    String? // Link to Ingredient if matched
  ingredient      Ingredient?      @relation(fields: [ingredientId], references: [id], onDelete: SetNull)
  pricing         SupplierPricing[]
  orderItems     PurchaseOrderItem[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@unique([supplierId, supplierSku])
  @@index([supplierId])
  @@index([ingredientId])
  @@index([name])
}

// Supplier Pricing History - tracks price changes over time
model SupplierPricing {
  id              String         @id @default(cuid())
  supplierId      String
  supplier        Supplier       @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  productId       String
  product         SupplierProduct @relation(fields: [productId], references: [id], onDelete: Cascade)
  price           Float // Price per unit
  effectiveDate   DateTime // When this price became effective
  expirationDate  DateTime? // When this price expires (if applicable)
  notes           String? // Notes about price change
  createdAt       DateTime       @default(now())

  @@index([supplierId])
  @@index([productId])
  @@index([effectiveDate])
}

// Purchase Orders - orders placed with suppliers
model PurchaseOrder {
  id              String            @id @default(cuid())
  orderNumber     String            @unique // Human-readable PO number (e.g., "PO-2025-001")
  supplierId      String
  supplier        Supplier          @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  connectionId    String? // Which supplier connection was used
  status          String            @default("draft") // "draft", "submitted", "confirmed", "shipped", "received", "cancelled"
  orderDate       DateTime          @default(now())
  requestedDate   DateTime? // Requested delivery date
  receivedDate    DateTime? // Actual received date
  subtotal        Float             @default(0)
  tax             Float             @default(0)
  shipping        Float             @default(0)
  total           Float             @default(0)
  notes           String?
  posOrderId      String? // Order ID from supplier's system (if available)
  items           PurchaseOrderItem[]
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([supplierId])
  @@index([status])
  @@index([orderDate])
}

// Purchase Order Items - individual items in purchase orders
model PurchaseOrderItem {
  id              String         @id @default(cuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder  @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  productId       String?
  product          SupplierProduct? @relation(fields: [productId], references: [id], onDelete: SetNull)
  ingredientId    String? // Link to ingredient if product not matched
  ingredient      Ingredient?    @relation(fields: [ingredientId], references: [id], onDelete: SetNull)
  name            String // Product name at time of order
  supplierSku     String? // SKU from supplier
  quantity        Float // Quantity ordered
  unit            String // Unit of measure
  unitPrice       Float // Price per unit
  totalPrice      Float // Total price for this line item
  notes           String?
  receivedQty     Float? // Quantity actually received
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([purchaseOrderId])
  @@index([productId])
  @@index([ingredientId])
}

// Feature Flags - Controls visibility of features in the admin panel
model FeatureFlag {
  id          String   @id @default(cuid())
  key         String   @unique // e.g., "boh_connections", "online_ordering"
  name        String // Display name for UI
  description String? // Description of what this feature controls
  isEnabled   Boolean  @default(false) // Whether the feature is enabled
  category    String? // Optional category grouping (e.g., "operations", "marketing")
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())

  @@index([isEnabled])
  @@index([category])
}
