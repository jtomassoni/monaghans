// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Special {
  id          String    @id @default(cuid())
  title       String
  description String?
  priceNotes  String? // e.g., "$3 drafts", "Happy hour prices"
  type        String    @default("food") // "food" or "drink"
  appliesOn   String? // JSON array of weekdays: ["Monday", "Tuesday", ...] (optional for date-specific)
  timeWindow  String? // e.g., "11am-3pm", "Happy Hour"
  startDate   DateTime? // Optional start date
  endDate     DateTime? // Optional end date
  image       String? // Path to image in /public/uploads
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Event {
  id             String    @id @default(cuid())
  title          String
  description    String?
  startDateTime  DateTime
  endDateTime    DateTime?
  venueArea      String    @default("bar") // "bar", "stage", "other"
  recurrenceRule String? // RRULE string (RFC 5545)
  exceptions     String? // JSON array of exception dates: ["2024-01-15", ...]
  isAllDay       Boolean   @default(false)
  tags           String? // JSON array of tags: ["live-music", "trivia", ...]
  image          String? // Path to image in /public/uploads
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

model Announcement {
  id                 String    @id @default(cuid())
  title              String
  body               String // Rich text content (markdown or HTML)
  heroImage          String? // Path to image
  publishAt          DateTime? // When to start showing the announcement
  expiresAt          DateTime? // When to stop showing the announcement
  isPublished        Boolean   @default(false)
  crossPostFacebook  Boolean   @default(false)
  crossPostInstagram Boolean   @default(false)
  ctaText            String? // Call-to-action button text
  ctaUrl             String? // Call-to-action button URL
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
}

model Setting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String // JSON value for complex data
  description String?
  updatedAt   DateTime @updatedAt
}

model PostQueue {
  id          String    @id @default(cuid())
  channel     String // "facebook", "instagram"
  payload     String // JSON payload with caption, link, image, etc.
  status      String    @default("staged") // "staged", "sent", "failed"
  scheduledAt DateTime?
  sentAt      DateTime?
  error       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model FacebookPost {
  id        String   @id @default(cuid())
  postId    String   @unique
  pageId    String
  message   String
  link      String?
  imageUrl  String?
  permalink String?
  createdBy String?
  postedAt  DateTime @default(now())
  createdAt DateTime @default(now())

  @@index([pageId])
}

model MenuSection {
  id           String     @id @default(cuid())
  name         String // e.g., "Starters", "Burgers", "Mexican"
  description  String? // Optional section description
  displayOrder Int        @default(0) // For ordering sections
  menuType     String     @default("dinner") // "breakfast", "dinner", "both"
  isActive     Boolean    @default(true)
  items        MenuItem[]
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model User {
  id         String        @id @default(cuid())
  email      String        @unique
  name       String?
  image      String? // Profile image from Google
  role       String        @default("admin") // "superadmin" or "admin"
  isActive   Boolean       @default(true)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  activities ActivityLog[]
}

model ActivityLog {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  action      String // "create", "update", "delete"
  entityType  String // "menuItem", "menuSection", "event", "special", "announcement", "user", "setting"
  entityId    String
  entityName  String? // Display name of the entity (e.g., "Cheeseburger")
  changes     String? // JSON object with before/after values for updates
  description String // Human-readable description (e.g., "Changed name from 'A' to 'B'")
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

model Order {
  id                  String      @id @default(cuid())
  orderNumber         String      @unique // Human-readable order number (e.g., "ORD-2025-001")
  status              String      @default("pending") // "pending", "confirmed", "preparing", "ready", "completed", "cancelled"
  customerName        String
  customerEmail       String
  customerPhone       String
  customerAddress     String? // For delivery (future feature)
  pickupTime          DateTime? // Requested pickup/delivery time
  subtotal            Float       @default(0)
  tax                 Float       @default(0)
  tip                 Float       @default(0)
  total               Float       @default(0)
  paymentStatus       String      @default("pending") // "pending", "paid", "failed", "refunded"
  paymentMethod       String? // "card", "cash", etc.
  stripePaymentId     String? // Stripe payment intent ID
  specialInstructions String? // Customer notes
  items               OrderItem[]
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  completedAt         DateTime?
  // Timing fields for performance tracking
  confirmedAt         DateTime? // When order was confirmed
  preparingAt         DateTime? // When order started being prepared
  readyAt             DateTime? // When order was marked ready

  @@index([status])
  @@index([createdAt])
  @@index([customerEmail])
}

model OrderItem {
  id                  String    @id @default(cuid())
  orderId             String
  order               Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItemId          String? // Reference to MenuItem (null if custom item)
  menuItem            MenuItem? @relation(fields: [menuItemId], references: [id], onDelete: SetNull)
  name                String // Item name at time of order (for historical accuracy)
  description         String? // Item description at time of order
  price               Float     @default(0) // Price at time of order
  quantity            Int       @default(1)
  modifiers           String? // JSON array of selected modifiers
  specialInstructions String? // Item-specific notes
  createdAt           DateTime  @default(now())

  @@index([orderId])
  @@index([menuItemId])
}

// Add relation to MenuItem for orders
model MenuItem {
  id           String      @id @default(cuid())
  sectionId    String
  section      MenuSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  name         String
  description  String? // Optional item description
  price        String? // Price as string (e.g., "$14", "$8-12", "Market Price")
  priceNotes   String? // Additional pricing info (e.g., "Full: $14, Half: $8")
  modifiers    String? // JSON array of modifier options
  isAvailable  Boolean     @default(true)
  displayOrder Int         @default(0) // For ordering within section
  orderItems   OrderItem[] // Relation to orders
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([sectionId])
}
